---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  mobile?: boolean;
}

const { headings, mobile = false } = Astro.props;

// Include all heading levels (h2-h6)
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 6);

// Build a tree structure for nested headings
interface TocItem {
  heading: Heading;
  children: TocItem[];
}

function buildTree(headings: Heading[]): TocItem[] {
  const root: TocItem[] = [];
  const stack: { item: TocItem; depth: number }[] = [];

  for (const heading of headings) {
    const item: TocItem = { heading, children: [] };

    while (stack.length > 0 && stack[stack.length - 1].depth >= heading.depth) {
      stack.pop();
    }

    if (stack.length === 0) {
      root.push(item);
    } else {
      stack[stack.length - 1].item.children.push(item);
    }

    stack.push({ item, depth: heading.depth });
  }

  return root;
}

const tocTree = buildTree(tocHeadings);

// Flatten tree with depth info for rendering
interface FlatItem {
  heading: Heading;
  hasChildren: boolean;
  isLastChild: boolean;
  depth: number;
  parentDepths: number[];
}

function flattenTree(items: TocItem[], depth: number = 0, parentDepths: number[] = []): FlatItem[] {
  const result: FlatItem[] = [];
  items.forEach((item, index) => {
    const isLastChild = index === items.length - 1;
    result.push({
      heading: item.heading,
      hasChildren: item.children.length > 0,
      isLastChild,
      depth,
      parentDepths: [...parentDepths],
    });
    if (item.children.length > 0) {
      result.push(...flattenTree(item.children, depth + 1, [...parentDepths, depth]));
    }
  });
  return result;
}
---

{tocHeadings.length > 0 && (
  <nav class:list={[
    "toc-nav",
    mobile ? "block" : "hidden xl:block sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto"
  ]}>
    {!mobile && (
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-text-secondary uppercase tracking-wide">
          On this page
        </h2>
        {/* <button
          class="toc-expand-collapse text-xs text-text-secondary hover:text-text px-1.5 py-0.5 hover:bg-bg-secondary rounded"
          data-expanded="true"
          aria-label="Collapse all sections"
        >
          Collapse all
        </button> */}
      </div>
    )}
    <ul class="toc-list space-y-0.5 text-sm" data-toc-root>
      {tocTree.map((item) => (
        <li class="toc-item" data-depth="0" data-has-children={item.children.length > 0 ? "true" : "false"}>
          <div class="flex items-center gap-1">
            {/* {item.children.length > 0 ? (
              <button
                class="toc-toggle p-0.5 hover:bg-bg-secondary rounded text-text-secondary flex-shrink-0"
                aria-label="Toggle section"
                data-expanded="true"
              >
                <svg class="w-3 h-3 transition-transform toc-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
            ) : (
              <span class="w-4 flex-shrink-0"></span>
            )} */}
            <a
              href={`#${item.heading.slug}`}
              class="toc-link block py-1 text-text-secondary hover:text-text transition-colors"
              data-slug={item.heading.slug}
            >
              {item.heading.text}
            </a>
          </div>
          {item.children.length > 0 && (
            <ul class="toc-children ml-4 space-y-0.5 overflow-hidden">
              {item.children.map((child) => (
                <li class="toc-item" data-depth="1" data-has-children={child.children.length > 0 ? "true" : "false"}>
                  <div class="flex items-center gap-1">
                    {/* {child.children.length > 0 ? (
                      <button
                        class="toc-toggle p-0.5 hover:bg-bg-secondary rounded text-text-secondary flex-shrink-0"
                        aria-label="Toggle section"
                        data-expanded="true"
                      >
                        <svg class="w-3 h-3 transition-transform toc-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>
                    ) : (
                      <span class="w-4 flex-shrink-0"></span>
                    )} */}
                    <a
                      href={`#${child.heading.slug}`}
                      class="toc-link block py-1 text-text-secondary hover:text-text transition-colors"
                      data-slug={child.heading.slug}
                    >
                      {child.heading.text}
                    </a>
                  </div>
                  {child.children.length > 0 && (
                    <ul class="toc-children ml-4 space-y-0.5 overflow-hidden">
                      {child.children.map((grandchild) => (
                        <li class="toc-item" data-depth="2" data-has-children={grandchild.children.length > 0 ? "true" : "false"}>
                          <div class="flex items-center gap-1">
                            {/* {grandchild.children.length > 0 ? (
                              <button
                                class="toc-toggle p-0.5 hover:bg-bg-secondary rounded text-text-secondary flex-shrink-0"
                                aria-label="Toggle section"
                                data-expanded="true"
                              >
                                <svg class="w-3 h-3 transition-transform toc-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                              </button>
                            ) : (
                              <span class="w-4 flex-shrink-0"></span>
                            )} */}
                            <a
                              href={`#${grandchild.heading.slug}`}
                              class="toc-link block py-1 text-text-secondary hover:text-text transition-colors"
                              data-slug={grandchild.heading.slug}
                            >
                              {grandchild.heading.text}
                            </a>
                          </div>
                          {grandchild.children.length > 0 && (
                            <ul class="toc-children ml-4 space-y-0.5 overflow-hidden">
                              {grandchild.children.map((greatgrandchild) => (
                                <li class="toc-item" data-depth="3">
                                  <div class="flex items-center gap-1">
                                    <span class="w-4 flex-shrink-0"></span>
                                    <a
                                      href={`#${greatgrandchild.heading.slug}`}
                                      class="toc-link block py-1 text-text-secondary hover:text-text transition-colors"
                                      data-slug={greatgrandchild.heading.slug}
                                    >
                                      {greatgrandchild.heading.text}
                                    </a>
                                  </div>
                                </li>
                              ))}
                            </ul>
                          )}
                        </li>
                      ))}
                    </ul>
                  )}
                </li>
              ))}
            </ul>
          )}
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  function initTOC() {
    // Toggle functionality for collapsible sections
    document.querySelectorAll('.toc-toggle').forEach((button) => {
      // Remove existing listeners by cloning
      const newButton = button.cloneNode(true);
      button.parentNode?.replaceChild(newButton, button);

      newButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const item = (e.currentTarget as HTMLElement).closest('.toc-item');
        const children = item?.querySelector(':scope > .toc-children') as HTMLElement;
        const chevron = (e.currentTarget as HTMLElement).querySelector('.toc-chevron');
        const isExpanded = (e.currentTarget as HTMLElement).dataset.expanded === 'true';

        if (children) {
          if (isExpanded) {
            children.style.maxHeight = '0';
            children.style.opacity = '0';
            (e.currentTarget as HTMLElement).dataset.expanded = 'false';
            chevron?.classList.add('-rotate-90');
          } else {
            children.style.maxHeight = children.scrollHeight + 'px';
            children.style.opacity = '1';
            (e.currentTarget as HTMLElement).dataset.expanded = 'true';
            chevron?.classList.remove('-rotate-90');
          }
        }
      });
    });

    // Initialize all children as expanded
    document.querySelectorAll('.toc-children').forEach((el) => {
      (el as HTMLElement).style.maxHeight = el.scrollHeight + 'px';
      (el as HTMLElement).style.opacity = '1';
      (el as HTMLElement).style.transition = 'max-height 0.2s ease, opacity 0.2s ease';
    });

    // Expand/Collapse all button functionality
    document.querySelectorAll('.toc-expand-collapse').forEach((button) => {
      const newButton = button.cloneNode(true);
      button.parentNode?.replaceChild(newButton, button);

      newButton.addEventListener('click', (e) => {
        e.preventDefault();
        const btn = e.currentTarget as HTMLElement;
        const nav = btn.closest('.toc-nav');
        const isExpanded = btn.dataset.expanded === 'true';

        if (isExpanded) {
          // Collapse all
          nav?.querySelectorAll('.toc-children').forEach((el) => {
            (el as HTMLElement).style.maxHeight = '0';
            (el as HTMLElement).style.opacity = '0';
          });
          nav?.querySelectorAll('.toc-toggle').forEach((toggle) => {
            (toggle as HTMLElement).dataset.expanded = 'false';
            toggle.querySelector('.toc-chevron')?.classList.add('-rotate-90');
          });
          btn.dataset.expanded = 'false';
          btn.textContent = 'Expand all';
          btn.setAttribute('aria-label', 'Expand all sections');
        } else {
          // Expand all
          nav?.querySelectorAll('.toc-children').forEach((el) => {
            (el as HTMLElement).style.maxHeight = el.scrollHeight + 'px';
            (el as HTMLElement).style.opacity = '1';
          });
          nav?.querySelectorAll('.toc-toggle').forEach((toggle) => {
            (toggle as HTMLElement).dataset.expanded = 'true';
            toggle.querySelector('.toc-chevron')?.classList.remove('-rotate-90');
          });
          btn.dataset.expanded = 'true';
          btn.textContent = 'Collapse all';
          btn.setAttribute('aria-label', 'Collapse all sections');
        }
      });
    });

    // Highlight current section on scroll
    const tocLinks = document.querySelectorAll('.toc-link');
    const headingSlugs = Array.from(tocLinks).map((link) => link.getAttribute('data-slug')).filter(Boolean);
    const headingElements = headingSlugs.map((slug) => document.getElementById(slug || '')).filter(Boolean);

    if (headingElements.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const slug = entry.target.id;
            tocLinks.forEach((l) => l.classList.remove('text-text', 'font-medium'));
            document.querySelectorAll(`.toc-link[data-slug="${slug}"]`).forEach((link) => {
              link.classList.add('text-text', 'font-medium');
            });
          }
        });
      },
      { rootMargin: '-80px 0px -80% 0px' }
    );

    headingElements.forEach((heading) => heading && observer.observe(heading));
  }

  // Run on initial load
  initTOC();

  // Re-run on Astro page transitions
  document.addEventListener('astro:after-swap', initTOC);
</script>
